# 版本功能更新记录

## v3.1.7.5

- 修复`SqlExecutor.GetInit`的线程安全问题
- ⚡️支持重写表名`Select<T>(string overriddenTableName)`, `XXXJoin<T2>(string overriddenTableName, ...)`
- ⚡️增加`TableLinkType.FullOuterJoin`
- 🐞修复Select多个表时, SwitchDatabase的一个BUG
- ⚡️增加是否使用标识引用符号(例如Oracle中的`""`, SqlServer中的`[]`等等)。默认启用(对数据库关键词强制使用)，通过`IDbOption.UseIdentifierQuote`和`IDbOption.AddDbKeyWords`进行设置。
- 🛠`LightORM.Providers.*`的最低依赖版本更新

  | Provider                        | 版本    | LightORM版本 |
      |---------------------------------|-------|------------|
  | `LightORM.Providers.Dameng`     | 0.0.2 | 3.1.7.5    |
  | `LightORM.Providers.MySql`      | 0.1.2 | 3.1.7.5    |
  | `LightORM.Providers.Oracle`     | 0.1.2 | 3.1.7.5    |
  | `LightORM.Providers.PostgreSQL` | 0.0.5 | 3.1.7.5    |
  | `LightORM.Providers.Sqlite`     | 0.1.2 | 3.1.7.5    |
  | `LightORM.Providers.SqlServer`  | 0.1.2 | 3.1.7.5    |

## v3.1.7.4

- ⚡️`IExpSelect0<TSelect, T1>`增加原生sql写法，需要自己检验SQL是否合法

```csharp
TSelect WithParameters(object parameters);
TSelect Where(string sql, object? parameters = null);
TSelect WhereIf(bool condition, string sql, object? parameters = null);
TSelect GroupBy(string sql, object? parameters = null);
TSelect Having(string sql, object? parameters = null);
TSelect OrderBy(string sql, object? parameters = null);
```

## v3.1.7.3

- ⚡️重构`IDatabaseTableHandler`，整合CS类的生成逻辑，`IExpressionContext`新增功能`ITableAction`
- 🛠`LightORM.Providers.*`的最低依赖版本更新

  | Provider                        | 版本    | LightORM版本 |
    |---------------------------------|-------|------------|
  | `LightORM.Providers.Dameng`     | 0.0.1 | 3.1.7.3    |
  | `LightORM.Providers.MySql`      | 0.1.1 | 3.1.7.3    |
  | `LightORM.Providers.Oracle`     | 0.1.1 | 3.1.7.3    |
  | `LightORM.Providers.PostgreSQL` | 0.0.4 | 3.1.7.3    |
  | `LightORM.Providers.Sqlite`     | 0.1.1 | 3.1.7.3    |
  | `LightORM.Providers.SqlServer`  | 0.1.1 | 3.1.7.3    |

## v3.1.7.2

- 🐞修复当调用`Count(out long total)`前有Where的话，出现字典重复添加参数的BUG

## v3.1.7.1

- ⚡️`IExpressionContext`新增扩展方法`GetRepository<TEntity>`
- ⚡️新增`LightORM.Providers.Dameng`
- ⚡️反射处理`LightColumnAttribute`的`Length`属性时，如果为0，应为null

## v3.1.7.0

- 🐞修复委托构建的基础类型处理

## v3.1.6.9

- 🐞`void RemoveLast(this StringBuilder stringBuilder, int length)`添加参数安全性检查
- 🐞插入实体时，如果列数为0，抛出异常
- ⚡️优化委托构建

## v3.1.6.8

- 🛠重构SwitchDatabase
- ⚡️开窗函数支持一对一的导航属性
- ⚡️`Update(entity)`时，不再更新自增列的值
- 🐞修复`RollbackTransactionAsync`会提前释放事务上下文的BUG
- ⚡️`IExpInsert<T>`新增`InsertEach`和`InsertEachAsync`扩展方法，循环插入数据

## v3.1.6.7

- 🛠Delete删除重载`Delete(bool force, bool truncate = false)`, `IExpDelete`新增
  `IExpDelete<T> FullDelete(bool truncate = false);`
- 🛠重构表达式解析，分离语句的拼接和变量的处理
- 🛠缓存重构，删除`StaticCache`类以及相关的使用
- ⚡️添加变量是否参数化的配置，可使用`IExpressionContextSetup.SetUseParameterized`全局配置或者
  `IExpSelect.Parameterized(bool use)`单独配置
- 🛠重构`SqlBuilder`
- 🛠优化GroupBy的表达式解析
- ⚡️添加`ILightOrmRepository<>`，支持Linq操作
- ⚡️`IExpSelect`增加`Skip`和`Take`api
- 🐞修复DbDataReader表达式构建委托的两个BUG
    - 优化字符串转布尔值，支持1和0转布尔值
    - 当获取不到AllowDbNull的值时，默认检查空值

## v3.1.6.6

- ⚡️DbDataReader表达式构建委托新增对ulong、uint、ushort类型的处理

## v3.1.6.5

- ⚡️新增版本列支持的类型
- 🛠版本列只对第一个生效
- 🛠`IExpSelect<T>`新增`SelectColumns`扩展方法
- 🛠优化默认的ToList和First，如果已经设置了Select的内容，就不再设置
- 🛠Select -> Insert修改
- 🐞事务提交之后，连接池的连接没有被正确返回连接池

## v3.1.6.4

- 🐞修复DbDataReader返还连接到连接池的行为，导致在事务操作的范围内，连接对象被意外释放的BUG

## v3.1.6.3

- ⚡️添加`CreateTable<T>`方法

## v3.1.6.2

- ⚡️`SqlFn`新增`Max`方法
- ⚡️方法解析中，新增对Max、Min、Avg、Sum的嵌套处理

## v3.1.6.1

- ⚡️Delete添加对导航属性的处理，可以使用导航属性进行条件删除，生成如下语句

```sql

DELETE
FROM `USER`
WHERE `USER_ID` IN (SELECT `a`.`USER_ID`
                    FROM `USER` `a`
                             INNER JOIN `USER_ROLE` `b` ON (`a`.`USER_ID` = `b`.`USER_ID`)
                             INNER JOIN `ROLE` `c` ON (`c`.`ROLE_ID` = `b`.`ROLE_ID`)
                    WHERE `c`.`ROLE_NAME` LIKE 'admin' || '%')

DELETE
FROM `USER_ROLE`
WHERE `USER_ID` IN (SELECT `a`.`USER_ID`
                    FROM `USER_ROLE` `a`
                             INNER JOIN `USER` `b` ON (`a`.`USER_ID` = `b`.`USER_ID`)
                    WHERE (`b`.`AGE` > 10))
```

## v3.1.6.0

- ⚡️Delete增加重载，支持全表删除`Delete(bool force, bool truncate = false)`

## v3.1.5.9

- 🐞修复插入操作时，应该忽略自增列

## v3.1.5.8

- 🐞修复`UseInterceptor`注入后获取失败

## v3.1.5.7

- ⚡️支持版本列乐观锁控制
- 🛠`IExpressionContext.Insert`、`IExpressionContext.Update`、`IExpressionContext.Detele`删除重载，改成
  `(params T[] entities)`，根据参数数量选择是否执行批量操作
- ⚡️Ado执行Sql的Aop功能优化，添加异常处理，已处理的异常会返回默认值，NonQuery -> 0, Scalar -> default, Reader ->
  EmptyDataReader等等。

## v3.1.5.6

- 🛠改造`ISqlExecutor`
- 🐞修复`SqlExecutor`的`AsyncLocal<TransactionContext?>`初始化问题，支持BeginTranAsync

## v3.1.5.5

- 🛠改造`ISqlExecutor`

## v3.1.5.4

- 🛠`SqlExecutorExtensions.QueryAsync` -> `SqlExecutorExtensions.QueryListAsync`
- ⚡️`SqlExecutorExtensions`新增扩展方法`QueryAsync`, 返回值为`IAsyncEnumerable<>`
- ⚡️`IExpSelect<>`添加`ToEnumerableAsync`方法, 返回值为`IAsyncEnumerable<>`

## v3.1.5.3

- 🐞处理`LightFlatAttribute`的属性时，添加对Nullable的处理
- 🐞修复处理`LightFlatAttribute`的插入和更新
- 🐞修复不使用生成器的情况下，`LightFlatAttribute`的GetValue和SetValue

## v3.1.5.2

- ⚡️优化生成器，支持将字段定义到抽象类中并从中继承

## v3.1.5.1

- 🐞生成的Update语句错误

## v3.1.5

- 🐞`GetTableInfo`只有抽象类和接口才判断继承关系
- 🐞修复Select`2时没有flat expression。
- ⚡️优化flat expression，去掉group操作中的Group和Tables
- ⚡️异步方法添加`CancellationToken`参数
- ⚡️TableContext生成器逻辑修改，TableEntityInfo做静态化处理
- 🛠重构表别名解析
- 🛠`WhereIf`导航筛选表达式延迟解析
- ⚡️Providers支持配置`DbFactoryProvider`

## v3.1.5-pre

- 🐞修复`WhereIf`方法解析，修复解析`NewExpression`时，属性名为Tb时会出现的bug
- ⚡️优化TableContext和TableInfo的生成，ColumnInfo做静态化处理
- ⚡️增加属性扁平化功能，如下所示
- ⚡️ToList新增重载

```CSharp
public class UserFlat
{
    [LightFlat]
    public PrivateInfo PriInfo { get; set; }
}

public class PrivateInfo
{
    [LightColumn(Name = "AGE")]
    public int? Age { get; set; }
    [LightColumn(Name = "IS_LOCK")]
    public bool IsLock { get; set; }
}
```

- ⚡️BaseSqlMethodResolver增加Format方法，支持在表达式中使用插值字符串语法

## v3.1.4

- ⚡️对IfNull,IsNull,Nvl函数进行抽象 => NullThen
- ⚡️增加CountDistinct函数
- ⚡️Count函数解析IExpSelect中嵌套IExpSelect，新增Exits拓展函数

